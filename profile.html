<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
  <title>ChouxLab - My Profile</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Fraunces:opsz,wght@9..144,300;400;600&family=Inter:wght@300;400;500&family=Work+Sans:wght@300;400;500;700&family=DM+Serif+Display&family=Playfair+Display:wght@400;600;700&family=Alice&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "mocha": "#3D2B1F",
            "dark-chocolate": "#2A1D15",
            "dark-brown": "#32211D",
            "cream": "#FDFBF7",
            "cream-bg": "#FCF9F2",
            "warm-beige": "#F5F0E8",
            "soft-cocoa": "#8B7E74",
            "accent-tan": "#C7B7A3",
            "tan-light": "#f2e4cf",
            "nude": "#E7C0A5",
            "beige": "#EBC2A4",
            "tan": "#D1B28C",
            "warm-grey": "#8E7366",
            "primary": "#36211c",
            "background-light": "#fffcf5",
            "background-dark": "#1a1210",
          },
          fontFamily: {
            "roca": ["Crimson Pro", "serif"],
            "cooper": ["Fraunces", "serif"],
            "display": ["Fraunces", "serif"],
            "accent": ["Alice", "serif"],
            "body": ["Work Sans", "sans-serif"],
            "sans": ["Inter", "sans-serif"],
          },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply bg-cream text-dark-chocolate antialiased;
        font-family: 'Fraunces', serif;
        min-height: 100dvh;
        overflow-x: hidden;
      }
    }

    .font-roca { font-family: 'Crimson Pro', serif; }
    .font-cooper { font-family: 'Fraunces', serif; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
    }
    .fill-1 { font-variation-settings: 'FILL' 1; }

    .screen {
      min-height: 100dvh;
      background-color: #FDFBF7;
    }

    .bottom-nav-directory {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background-color: rgba(253, 251, 247, 0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(199, 183, 163, 0.2);
      padding: 12px 24px 28px 24px;
      max-width: 430px;
      margin: 0 auto;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }
    .nav-item:active {
      opacity: 0.6;
      transform: scale(0.95);
    }
    .nav-icon { font-size: 24px; line-height: 1; }
    .nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Fraunces', serif;
    }
    .nav-item.active .nav-icon {
      font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .nav-item.active .nav-label { font-weight: 700; }

    .screen-content { padding-bottom: 88px; }

    input:focus, textarea:focus {
      outline: none !important;
      box-shadow: none !important;
    }
  </style>
</head>

<body class="bg-cream-bg">
  <div id="screen-profile" class="screen active">
    <div class="relative mx-auto min-h-screen max-w-[430px] bg-background-light flex flex-col">

      <!-- Top Nav -->
      <nav class="sticky top-0 z-50 bg-background-light/90 backdrop-blur-md border-b border-mocha/20">
        <div class="flex items-center p-4 justify-between">
          <div class="flex size-12 items-center justify-start">
            <span class="material-symbols-outlined cursor-pointer text-primary" onclick="navigateTo('home')">arrow_back_ios</span>
          </div>
          <h2 class="text-xl font-bold leading-tight tracking-tight flex-1 text-center text-primary font-roca">My Profile</h2>
          <div class="flex w-12 items-center justify-end">
            <button class="flex items-center justify-center rounded-full h-10 w-10 bg-transparent text-primary" onclick="openAccountMenu()">
              <span class="material-symbols-outlined">settings</span>
            </button>
          </div>
        </div>
      </nav>

      <main class="screen-content max-w-md mx-auto w-full">

        <!-- Logged out / anonymous state -->
        <section id="logged-out-state" class="hidden px-6 pt-10">
          <div class="bg-white rounded-3xl border border-mocha/10 p-8 shadow-sm text-center">
            <div class="mx-auto h-16 w-16 rounded-full bg-warm-beige/60 flex items-center justify-center mb-5">
              <span class="material-symbols-outlined text-primary text-3xl fill-1">person</span>
            </div>
            <h3 class="text-2xl font-roca font-bold text-primary">Sign in to view your orders</h3>
            <p class="text-sm font-cooper text-mocha mt-2">
              You need an account to see order history and rewards.
            </p>
            <button
              class="mt-7 w-full bg-primary text-cream py-4 rounded-full text-xs font-bold uppercase tracking-[0.2em] shadow-lg active:scale-[0.98] transition-all"
              onclick="goLogin()"
            >
              Go to Login
            </button>
            <button
              class="mt-3 w-full border border-mocha/20 text-primary py-4 rounded-full text-xs font-bold uppercase tracking-[0.2em] active:scale-[0.98] transition-all"
              onclick="navigateTo('menu')"
            >
              Continue as Guest
            </button>
          </div>
        </section>

        <!-- Logged in state -->
        <section id="logged-in-state" class="hidden">

          <!-- Header -->
          <header class="flex p-8 flex-col items-center">
            <div class="relative mb-6">
              <div
                id="avatar"
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-28 w-28 border-[3px] border-mocha/30 shadow-sm"
                style='background-image: url("https://via.placeholder.com/256");'
                title="Profile photo"
              ></div>
            </div>

            <div class="text-center">
              <p id="profile-name" class="text-3xl font-bold tracking-tight mb-0.5 text-primary font-roca">Loading...</p>
              <p id="profile-sub" class="text-mocha text-sm mb-4 font-sans tracking-wide">Loading...</p>

              <div id="member-badge" class="inline-flex items-center gap-1.5 bg-mocha/10 text-mocha px-4 py-1.5 rounded-full text-xs font-semibold tracking-wide uppercase">
                <span class="material-symbols-outlined text-[14px] fill-1">workspace_premium</span>
                Member
              </div>
            </div>
          </header>

          <!-- Stats -->
          <section class="grid grid-cols-2 gap-4 px-4 mb-8">
            <div class="flex flex-col gap-1 rounded-2xl bg-white border border-mocha/10 p-5 items-center shadow-sm">
              <p id="stat-orders" class="text-2xl font-bold text-primary">0</p>
              <p class="text-mocha text-[10px] font-bold uppercase tracking-[0.1em]">Total Orders</p>
            </div>
            <div class="flex flex-col gap-1 rounded-2xl bg-white border border-mocha/10 p-5 items-center shadow-sm">
              <p id="stat-points" class="text-2xl font-bold text-primary">0</p>
              <p class="text-mocha text-[10px] font-bold uppercase tracking-[0.1em]">Choux Points</p>
            </div>
          </section>

          <!-- Tabs -->
          <nav class="mb-6 px-4">
            <div class="flex border-b border-mocha/10 gap-0">
              <button id="tab-active" class="flex-1 flex flex-col items-center justify-center border-b-2 border-primary text-primary pb-4" onclick="switchOrderTab('active')">
                <p class="text-xs font-bold uppercase tracking-widest">Active Orders</p>
              </button>
              <button id="tab-history" class="flex-1 flex flex-col items-center justify-center border-b-2 border-transparent text-mocha pb-4" onclick="switchOrderTab('history')">
                <p class="text-xs font-bold uppercase tracking-widest">Order History</p>
              </button>
            </div>
          </nav>

          <!-- Lists -->
          <section class="px-4 space-y-5 mb-8" id="active-orders"></section>
          <section class="px-4 space-y-5 hidden mb-8" id="order-history"></section>

          <!-- Empty states -->
          <div id="empty-active" class="hidden px-4 mb-8">
            <div class="bg-white rounded-2xl border border-mocha/10 p-6 shadow-sm text-center">
              <p class="text-primary font-roca font-bold text-lg">No active orders</p>
              <p class="text-mocha font-cooper text-sm mt-1">Place an order from the menu.</p>
              <button class="mt-4 bg-primary text-cream px-5 py-3 rounded-full text-xs font-bold uppercase tracking-widest" onclick="navigateTo('menu')">
                Go to Menu
              </button>
            </div>
          </div>

          <div id="empty-history" class="hidden px-4 mb-8">
            <div class="bg-white rounded-2xl border border-mocha/10 p-6 shadow-sm text-center">
              <p class="text-primary font-roca font-bold text-lg">No order history yet</p>
              <p class="text-mocha font-cooper text-sm mt-1">Your completed orders will appear here.</p>
            </div>
          </div>

          <!-- Account Settings -->
          <h2 class="text-lg font-bold px-4 pb-4 pt-10 text-primary uppercase tracking-[0.15em] font-roca">Account Settings</h2>
          <div class="px-4 space-y-3 pb-8">
            <button class="w-full flex items-center justify-between p-5 bg-white rounded-2xl border border-mocha/10 shadow-sm active:scale-[0.98] transition-transform" onclick="alert('Coming soon')">
              <div class="flex items-center gap-4">
                <span class="material-symbols-outlined text-mocha">location_on</span>
                <span class="text-sm font-semibold text-primary">Saved Addresses</span>
              </div>
              <span class="material-symbols-outlined text-mocha/40 text-[18px]">chevron_right</span>
            </button>

            <button class="w-full flex items-center justify-between p-5 bg-white rounded-2xl border border-mocha/10 shadow-sm active:scale-[0.98] transition-transform" onclick="alert('Coming soon')">
              <div class="flex items-center gap-4">
                <span class="material-symbols-outlined text-mocha">credit_card</span>
                <span class="text-sm font-semibold text-primary">Payment Methods</span>
              </div>
              <span class="material-symbols-outlined text-mocha/40 text-[18px]">chevron_right</span>
            </button>

            <button id="logout-btn" class="w-full flex items-center justify-between p-5 bg-white rounded-2xl border border-mocha/10 shadow-sm active:scale-[0.98] transition-transform">
              <div class="flex items-center gap-4 text-mocha">
                <span class="material-symbols-outlined">logout</span>
                <span class="text-sm font-semibold">Log Out</span>
              </div>
            </button>
          </div>
        </section>
      </main>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav-directory bg-background-light/95">
        <div class="flex justify-between items-center max-w-md mx-auto">
          <button class="nav-item text-mocha" onclick="navigateTo('home')">
            <span class="material-symbols-outlined nav-icon">home</span>
            <span class="nav-label">Home</span>
          </button>
          <button class="nav-item text-mocha" onclick="navigateTo('menu')">
            <span class="material-symbols-outlined nav-icon">restaurant_menu</span>
            <span class="nav-label">Menu</span>
          </button>
          <button class="nav-item text-mocha" onclick="navigateTo('cart')">
            <span class="material-symbols-outlined nav-icon">shopping_bag</span>
            <span class="nav-label">Cart</span>
          </button>
          <button class="nav-item active text-primary" onclick="navigateTo('profile')">
            <span class="material-symbols-outlined nav-icon fill-1">person</span>
            <span class="nav-label">Profile</span>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // === Firebase config (same as your firebase.js) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCTBt4C--X3oO9XvweyNqQtvR3QcmSZA7c",
      authDomain: "chouxlab-ops.firebaseapp.com",
      projectId: "chouxlab-ops",
      storageBucket: "chouxlab-ops.firebasestorage.app",
      messagingSenderId: "317568827205",
      appId: "1:317568827205:web:bde602b3d7c3b18e4a882c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === UI helpers ===
    function navigateTo(screenName) {
      if (screenName === "menu") window.location.href = "index.html";
      else window.location.href = screenName + ".html";
    }
    function goLogin() {
      window.location.href = "login.html";
    }
    function openAccountMenu() {
      // optional. for now just scroll to settings.
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    function moneyIDR(n) {
      return `Rp ${Number(n || 0).toLocaleString("id-ID")}`;
    }
    function fmtDate(ts) {
      // Firestore Timestamp or JS Date
      if (!ts) return "-";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("en-GB", { day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    function statusLabel(s) {
      const v = (s || "pending").toLowerCase();
      if (v === "pending") return { text: "Pending", pill: "bg-tan-light/30 text-mocha/80" };
      if (v === "preparing") return { text: "Preparing", pill: "bg-tan-light/50 text-mocha" };
      if (v === "out_for_delivery") return { text: "On the way", pill: "bg-mocha/10 text-mocha" };
      if (v === "delivered") return { text: "Delivered", pill: "bg-mocha/20 text-primary" };
      if (v === "cancelled") return { text: "Cancelled", pill: "bg-mocha/10 text-mocha/70" };
      return { text: v.replaceAll("_", " "), pill: "bg-mocha/10 text-mocha" };
    }

    // Active statuses vs history
    function isActiveStatus(s) {
      const v = (s || "pending").toLowerCase();
      return ["pending", "preparing", "out_for_delivery", "processing"].includes(v);
    }

    function setVisible(id, show) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("hidden", !show);
    }

    function setText(id, t) {
      const el = document.getElementById(id);
      if (el) el.textContent = t;
    }

    function setAvatar(url) {
      const el = document.getElementById("avatar");
      if (!el) return;
      const safe = url || "https://via.placeholder.com/256";
      el.style.backgroundImage = `url("${safe}")`;
    }

    // === Data ===
    async function ensureUserProfile(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        const payload = {
          uid: user.uid,
          displayName: user.displayName || "",
          email: user.email || "",
          photoURL: user.photoURL || "",
          points: 0,
          tier: "member",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        await setDoc(ref, payload, { merge: true });
        return payload;
      }

      const data = snap.data() || {};
      // keep it fresh if displayName/photo changes
      await setDoc(ref, {
        displayName: user.displayName || data.displayName || "",
        email: user.email || data.email || "",
        photoURL: user.photoURL || data.photoURL || "",
        updatedAt: serverTimestamp()
      }, { merge: true });

      return { ...data, uid: user.uid };
    }

    async function fetchOrders(uid, max = 50) {
      // IMPORTANT: your createOrder writes to "user_orders"
      const q = query(
        collection(db, "user_orders"),
        where("uid", "==", uid),
        orderBy("createdAt", "desc"),
        limit(max)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function orderCardHTML(order) {
      const id = order?.id ? order.id.slice(0, 6).toUpperCase() : "------";
      const status = statusLabel(order?.status);
      const created = fmtDate(order?.createdAt);

      const total = order?.pricing?.total ?? 0;
      const itemCount = order?.pricing?.itemCount ?? 0;

      const action = isActiveStatus(order?.status)
        ? `<button class="bg-primary text-cream px-5 py-2.5 rounded-full text-xs font-bold uppercase tracking-widest" onclick="alert('Tracking coming soon')">Track</button>`
        : `<button class="border border-mocha/30 text-mocha px-5 py-2.5 rounded-full text-xs font-bold uppercase tracking-widest flex items-center gap-2" onclick="alert('Reorder coming soon')">
             <span class="material-symbols-outlined text-[16px]">rebase_edit</span>
             Reorder
           </button>`;

      return `
        <div class="bg-white rounded-2xl border border-mocha/10 p-5 shadow-sm">
          <div class="flex justify-between items-start mb-5">
            <div>
              <p class="text-[10px] text-mocha font-bold uppercase tracking-wider mb-0.5">Order #${id}</p>
              <p class="text-sm font-bold text-primary">${created}</p>
            </div>
            <div class="flex items-center gap-1.5 ${status.pill} px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider">
              ${isActiveStatus(order?.status) ? `<span class="size-1.5 bg-mocha rounded-full"></span>` : `<span class="material-symbols-outlined text-[14px]">${(order?.status || "").toLowerCase()==="delivered" ? "check_circle" : "info"}</span>`}
              ${status.text}
            </div>
          </div>

          <div class="flex justify-between items-center pt-4 border-t border-mocha/10">
            <p class="text-lg font-bold text-primary">${moneyIDR(total)} ${itemCount ? `<span class="text-xs font-normal text-mocha">(${itemCount} items)</span>` : ""}</p>
            ${action}
          </div>
        </div>
      `;
    }

    function renderOrders(orders) {
      const activeWrap = document.getElementById("active-orders");
      const histWrap = document.getElementById("order-history");
      if (!activeWrap || !histWrap) return;

      activeWrap.innerHTML = "";
      histWrap.innerHTML = "";

      const active = [];
      const history = [];

      for (const o of orders || []) {
        if (isActiveStatus(o.status)) active.push(o);
        else history.push(o);
      }

      setVisible("empty-active", active.length === 0);
      setVisible("empty-history", history.length === 0);

      active.forEach(o => activeWrap.insertAdjacentHTML("beforeend", orderCardHTML(o)));
      history.forEach(o => histWrap.insertAdjacentHTML("beforeend", orderCardHTML(o)));

      // totals
      setText("stat-orders", String((orders || []).length));
    }

    function switchOrderTab(tab) {
      const tabActive = document.getElementById("tab-active");
      const tabHistory = document.getElementById("tab-history");

      const activeOrders = document.getElementById("active-orders");
      const historyOrders = document.getElementById("order-history");

      if (!tabActive || !tabHistory || !activeOrders || !historyOrders) return;

      if (tab === "active") {
        tabActive.classList.add("border-primary", "text-primary");
        tabActive.classList.remove("border-transparent", "text-mocha");
        tabHistory.classList.remove("border-primary", "text-primary");
        tabHistory.classList.add("border-transparent", "text-mocha");

        activeOrders.classList.remove("hidden");
        historyOrders.classList.add("hidden");

        // empty states visibility depends on which tab
        // keep them as is. they sit below lists.
      } else {
        tabHistory.classList.add("border-primary", "text-primary");
        tabHistory.classList.remove("border-transparent", "text-mocha");
        tabActive.classList.remove("border-primary", "text-primary");
        tabActive.classList.add("border-transparent", "text-mocha");

        activeOrders.classList.add("hidden");
        historyOrders.classList.remove("hidden");
      }
    }

    // Expose for onclick
    window.navigateTo = navigateTo;
    window.goLogin = goLogin;
    window.openAccountMenu = openAccountMenu;
    window.switchOrderTab = switchOrderTab;

    // === Auth bootstrap ===
    onAuthStateChanged(auth, async (user) => {
      // user missing OR anonymous -> show logged-out state
      if (!user || user.isAnonymous) {
        setVisible("logged-out-state", true);
        setVisible("logged-in-state", false);
        return;
      }

      setVisible("logged-out-state", false);
      setVisible("logged-in-state", true);

      // profile
      const profile = await ensureUserProfile(user);

      setText("profile-name", profile.displayName || user.displayName || "ChouxLab Member");
      setText("profile-sub", profile.email || user.email || "Signed in");
      setAvatar(profile.photoURL || user.photoURL);

      const points = Number(profile.points || 0);
      setText("stat-points", String(points));

      const tier = (profile.tier || "member").toUpperCase();
      const badge = document.getElementById("member-badge");
      if (badge) badge.innerHTML = `
        <span class="material-symbols-outlined text-[14px] fill-1">workspace_premium</span>
        ${tier}
      `;

      // orders
      const orders = await fetchOrders(user.uid, 50);
      renderOrders(orders);
      switchOrderTab("active"); // default
    });

    // Logout
    document.getElementById("logout-btn")?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        navigateTo("home");
      } catch (e) {
        console.error(e);
        alert("Logout failed.");
      }
    });
  </script>
</body>
</html>
