<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
  <title>ChouxLab - Payment</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Fraunces:opsz,wght@9..144,300;400;600&family=Inter:wght@300;400;500&family=Work+Sans:wght@300;400;500;700&family=DM+Serif+Display&family=Playfair+Display:wght@400;600;700&family=Alice&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "mocha": "#3D2B1F",
            "dark-chocolate": "#2A1D15",
            "dark-brown": "#32211D",
            "cream": "#FDFBF7",
            "cream-bg": "#FCF9F2",
            "warm-beige": "#F5F0E8",
            "soft-cocoa": "#8B7E74",
            "accent-tan": "#C7B7A3",
            "tan-light": "#f2e4cf",
            "nude": "#E7C0A5",
            "beige": "#EBC2A4",
            "tan": "#D1B28C",
            "warm-grey": "#8E7366",
            "primary": "#36211c",
            "background-light": "#fffcf5",
            "background-dark": "#1a1210",
          },
          fontFamily: {
            "roca": ["Crimson Pro", "serif"],
            "cooper": ["Fraunces", "serif"],
            "display": ["Fraunces", "serif"],
            "accent": ["Alice", "serif"],
            "body": ["Work Sans", "sans-serif"],
            "sans": ["Inter", "sans-serif"],
          },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply bg-cream text-dark-chocolate antialiased;
        font-family: 'Fraunces', serif;
        min-height: 100dvh;
        overflow-x: hidden;
      }
    }

    .font-roca { font-family: 'Crimson Pro', serif; }
    .font-cooper { font-family: 'Fraunces', serif; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
    }

    .fill-1 { font-variation-settings: 'FILL' 1; }

    .screen {
      min-height: 100dvh;
      background-color: #FDFBF7;
    }

    .bottom-nav-directory {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background-color: rgba(253, 251, 247, 0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(199, 183, 163, 0.2);
      padding: 12px 24px 28px 24px;
      max-width: 430px;
      margin: 0 auto;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .nav-item:active {
      opacity: 0.6;
      transform: scale(0.95);
    }

    .nav-icon { font-size: 24px; line-height: 1; }

    .nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Fraunces', serif;
    }

    .nav-item.active .nav-icon {
      font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .nav-item.active .nav-label { font-weight: 700; }

    .screen-content { padding-bottom: 88px; }

    input:focus, textarea:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-animate { animation: fadeIn 0.3s ease-out; }
  </style>
</head>

<body class="bg-cream-bg">

  <!-- AUTH MODAL: Login or Guest (kept as-is, you can wire it later to Firebase Auth) -->
  <div id="auth-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-dark-chocolate/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-sm bg-cream rounded-[32px] p-8 shadow-2xl modal-animate border border-accent-tan/20">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-roca text-dark-chocolate mb-2">Welcome</h2>
        <p class="text-sm text-soft-cocoa font-cooper italic">Secure checkout requires authentication</p>
      </div>

      <div id="auth-choice" class="space-y-4">
        <button onclick="showLoginForm()" class="w-full bg-dark-chocolate text-cream py-5 rounded-full font-semibold text-sm tracking-widest uppercase transition-transform active:scale-[0.98] shadow-lg flex items-center justify-center gap-3">
          <span class="material-symbols-outlined text-lg">login</span>
          Log In
        </button>

        <div class="relative flex py-2 items-center">
          <div class="flex-grow border-t border-accent-tan/30"></div>
          <span class="flex-shrink-0 mx-4 text-soft-cocoa text-xs uppercase tracking-widest">or</span>
          <div class="flex-grow border-t border-accent-tan/30"></div>
        </div>

        <button onclick="continueAsGuest()" class="w-full bg-transparent border-2 border-dark-chocolate/20 text-dark-chocolate py-5 rounded-full font-roca font-semibold text-sm tracking-widest uppercase transition-transform active:scale-[0.98] hover:bg-warm-beige/30">
          Continue as Guest
        </button>
      </div>

      <div id="login-form-view" class="hidden space-y-6">
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="font-cooper text-[10px] uppercase tracking-[0.2em] text-soft-cocoa font-semibold">Phone Number</label>
            <input type="tel" id="login-phone" class="w-full bg-warm-beige/40 rounded-2xl px-5 py-4 font-roca text-lg text-dark-chocolate placeholder:text-accent-tan/60 focus:outline-none focus:ring-2 focus:ring-mocha/20 border-0" placeholder="+62 812 3456 7890"/>
          </div>
          <div class="space-y-2">
            <label class="font-cooper text-[10px] uppercase tracking-[0.2em] text-soft-cocoa font-semibold">Password</label>
            <input type="password" id="login-password" class="w-full bg-warm-beige/40 rounded-2xl px-5 py-4 font-roca text-lg text-dark-chocolate placeholder:text-accent-tan/60 focus:outline-none focus:ring-2 focus:ring-mocha/20 border-0" placeholder="••••••••"/>
          </div>
        </div>

        <div class="pt-2 space-y-3">
          <button onclick="handleLogin()" class="w-full bg-dark-chocolate text-cream py-5 rounded-full font-semibold text-sm tracking-widest uppercase transition-transform active:scale-[0.98] shadow-lg">
            Sign In
          </button>
          <button onclick="showAuthChoice()" class="w-full text-soft-cocoa text-xs uppercase tracking-[0.2em] font-medium py-2 hover:text-dark-chocolate transition-colors">
            ← Back to options
          </button>
        </div>

        <div class="text-center">
          <a href="#" class="text-[10px] text-mocha underline hover:text-dark-chocolate">Forgot password?</a>
        </div>
      </div>

      <div id="guest-view" class="hidden space-y-4">
        <p class="text-center text-soft-cocoa text-sm font-cooper italic mb-4">
          You can complete your order without an account, but you won't be able to track history or earn points.
        </p>
        <button onclick="proceedAsGuest()" class="w-full bg-dark-chocolate text-cream py-5 rounded-full font-semibold text-sm tracking-widest uppercase transition-transform active:scale-[0.98]">
          Proceed to Payment
        </button>
        <button onclick="showAuthChoice()" class="w-full text-soft-cocoa text-xs uppercase tracking-widest font-medium py-2">
          Back
        </button>
      </div>
    </div>
  </div>

  <!-- PAYMENT SCREEN -->
  <div id="screen-payment" class="screen active">
    <div class="relative mx-auto min-h-screen max-w-[430px] bg-cream flex flex-col">
      <header class="sticky top-0 z-50 bg-cream/90 backdrop-blur-md">
        <div class="flex items-center px-6 py-8 justify-between">
          <button class="flex items-center justify-center text-dark-chocolate" onclick="navigateTo('shipping')">
            <span class="material-symbols-outlined text-2xl">arrow_back_ios</span>
          </button>
          <h1 class="text-2xl font-roca font-bold tracking-tight text-dark-chocolate">Payment</h1>
          <div class="w-8"></div>
        </div>
        <div class="flex items-center justify-center gap-12 pb-6">
          <div class="flex flex-col items-center gap-2 opacity-30">
            <div class="h-1.5 w-1.5 rounded-full bg-soft-cocoa"></div>
            <span class="text-[9px] uppercase tracking-widest font-medium text-soft-cocoa">Cart</span>
          </div>
          <div class="flex flex-col items-center gap-2 opacity-30">
            <div class="h-1.5 w-1.5 rounded-full bg-soft-cocoa"></div>
            <span class="text-[9px] uppercase tracking-widest font-medium text-soft-cocoa">Ship</span>
          </div>
          <div class="flex flex-col items-center gap-2">
            <div class="h-1.5 w-1.5 rounded-full bg-dark-chocolate"></div>
            <span class="text-[9px] uppercase tracking-widest font-bold text-dark-chocolate">Pay</span>
          </div>
        </div>
      </header>

      <main class="screen-content overflow-y-auto no-scrollbar px-6">
        <div class="py-4">
          <!-- ORDER SUMMARY (NEW) -->
          <div class="mb-8 p-6 rounded-3xl bg-warm-beige/20 border border-accent-tan/10">
            <div class="flex items-center gap-3 mb-4">
              <span class="material-symbols-outlined text-mocha text-sm">receipt_long</span>
              <p class="text-[10px] uppercase tracking-widest font-medium text-soft-cocoa">Order Summary</p>
            </div>

            <div class="space-y-2 text-sm font-cooper text-dark-chocolate">
              <div class="flex justify-between">
                <span class="text-soft-cocoa">Subtotal</span>
                <span id="sum-subtotal" class="font-roca font-semibold">Rp 0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-soft-cocoa">Packaging</span>
                <span id="sum-packaging" class="font-roca font-semibold">Rp 0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-soft-cocoa">Delivery</span>
                <span id="sum-delivery" class="font-roca font-semibold">Rp 0</span>
              </div>

              <div class="pt-3 mt-3 border-t border-accent-tan/20 flex justify-between items-center">
                <span class="text-soft-cocoa">Total</span>
                <span id="sum-total" class="font-roca text-lg font-semibold">Rp 0</span>
              </div>

              <!-- Map info (NEW) -->
              <div id="sum-map" class="pt-3 mt-3 border-t border-accent-tan/20 hidden">
                <p class="text-[10px] uppercase tracking-widest font-medium text-soft-cocoa mb-2">Delivery Location</p>
                <p id="sum-address" class="text-xs text-soft-cocoa italic leading-relaxed">-</p>
                <p id="sum-distance" class="text-xs text-soft-cocoa mt-1">-</p>
              </div>
            </div>
          </div>

          <h3 class="font-cooper text-sm uppercase tracking-wider font-bold text-dark-chocolate mb-2">Select Method</h3>
          <div class="space-y-4">
            <label class="relative block cursor-pointer">
              <input class="peer sr-only" name="payment_method" type="radio" value="bank_transfer"/>

              <div id="payment-method-card"
                   class="flex items-center justify-between p-5 rounded-2xl border border-mocha bg-warm-beige transition-all duration-300
                          peer-checked:border-dark-chocolate
                          peer-checked:[&_.pm-dot]:scale-100">

                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm">
                    <span class="material-symbols-outlined text-mocha text-2xl">account_balance</span>
                  </div>
                  <div>
                    <p class="font-roca text-lg font-semibold text-dark-chocolate">Bank Transfer</p>
                    <p class="font-cooper text-xs text-soft-cocoa italic">Virtual Account (BCA)</p>
                  </div>
                </div>

                <div class="relative w-4 h-4 rounded-full border-2 border-mocha flex items-center justify-center transition-colors peer-checked:border-dark-chocolate">
                  <span class="pm-dot absolute inset-0.5 rounded-full bg-dark-chocolate scale-0 transition-transform"></span>
                </div>
              </div>
            </label>
          </div>

          <div class="mt-12">
            <h3 class="font-cooper text-sm uppercase tracking-wider font-bold text-dark-chocolate mb-2">Payment Confirmation</h3>
            <div class="space-y-4">
              <p class="font-cooper text-md text-soft-cocoa italic leading-relaxed text-center px-5">
                Please upload your payment receipt for immediate processing.
              </p>
              <div class="relative group cursor-pointer" onclick="document.getElementById('receipt-upload').click()">
                <input accept="image/*" class="hidden" id="receipt-upload" type="file" onchange="handleReceiptUpload(event)"/>
                <label class="flex flex-col items-center justify-center w-full min-h-[180px] rounded-3xl border-2 border-dashed border-accent-tan/40 bg-warm-beige/20 p-8 transition-colors hover:bg-warm-beige/30 hover:border-accent-tan/60 active:scale-[0.99] cursor-pointer">
                  <div id="receipt-preview" class="w-14 h-14 rounded-full bg-white flex items-center justify-center shadow-sm mb-4 overflow-hidden">
                    <span class="material-symbols-outlined text-mocha text-2xl" id="receipt-icon">add_a_photo</span>
                    <img id="receipt-image" class="hidden w-full h-full object-cover"/>
                  </div>
                  <span class="font-roca text-base font-semibold text-dark-chocolate" id="receipt-text">Upload Receipt</span>
                  <span class="text-[11px] uppercase tracking-widest text-soft-cocoa mt-2 font-medium">(Upload Bukti)</span>
                </label>
              </div>
            </div>
          </div>

          <div class="mt-12 p-6 rounded-3xl bg-warm-beige/20 border border-accent-tan/10">
            <div class="flex items-center gap-3 mb-4">
              <span class="material-symbols-outlined text-mocha text-sm">info</span>
              <p class="text-[10px] uppercase tracking-widest font-medium text-soft-cocoa">Payment Information</p>
            </div>
            <p class="font-cooper text-xs leading-relaxed text-soft-cocoa italic">
              All transactions are encrypted and secure. Your order will be automatically verified once the receipt is successfully uploaded.
            </p>
          </div>
        </div>
      </main>

      <footer class="fixed bottom-0 left-0 right-0 mx-auto max-w-[430px] bg-cream/95 backdrop-blur-xl border-t border-accent-tan/10 z-40 pb-[88px]">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 px-1">
            <span class="text-soft-cocoa text-sm font-light">Order Total</span>
            <span id="payment-total" class="font-roca text-xl font-semibold">Rp 0</span>
          </div>

          <button id="place-order-btn" disabled
                  class="w-full bg-dark-chocolate text-cream py-5 rounded-full font-semibold text-sm tracking-widest uppercase flex items-center justify-center gap-3 transition-transform active:scale-[0.98] opacity-40 cursor-not-allowed">
            <span class="material-symbols-outlined text-lg">lock</span>
            <span id="place-order-text">Place Order</span>
          </button>

          <div class="flex items-center justify-center gap-2 mt-4 opacity-40">
            <span class="material-symbols-outlined text-[14px]">verified_user</span>
            <p class="text-[9px] uppercase tracking-[0.2em]">AES-256 Encrypted Security</p>
          </div>
        </div>
      </footer>

      <nav class="bottom-nav-directory">
        <div class="flex justify-between items-center max-w-md mx-auto">
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('home')">
            <span class="material-symbols-outlined nav-icon">home</span>
            <span class="nav-label">Home</span>
          </button>
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('menu')">
            <span class="material-symbols-outlined nav-icon">restaurant_menu</span>
            <span class="nav-label">Menu</span>
          </button>
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('cart')">
            <span class="material-symbols-outlined nav-icon">shopping_bag</span>
            <span class="nav-label">Cart</span>
          </button>
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('profile')">
            <span class="material-symbols-outlined nav-icon">person</span>
            <span class="nav-label">Profile</span>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <script type="module">
    import { initSession, getCart, createOrder, loadShippingDraftFromDB } from "./firebase.js";

    // Must match your menu/cart products
    const products = {
      vanilla: { id: "vanilla", name: "Vanilla", price: 65000 },
      chocolate: { id: "chocolate", name: "Chocolate", price: 65000 },
      pistachio: { id: "pistachio", name: "Pistachio & Rose", price: 85000 },
    };

    // If you used localStorage key in shipping.html
    const SHIPPING_KEY = "chouxlab_shipping_v1";

    let cart = {};
    let receiptFileName = null;
    let receiptFileBlob = null;
    let shippingDraft = null;

    function navigateTo(screenName) {
      if (screenName === "menu") window.location.href = "index.html";
      else window.location.href = screenName + ".html";
    }

    function formatRupiah(n) {
      const v = Number(n || 0);
      return `Rp ${v.toLocaleString("id-ID")}`;
    }

    function loadShippingDraftFallbackLocal() {
      try {
        const raw = localStorage.getItem(SHIPPING_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function deliveryCostFromDraft(draft) {
      if (!draft?.deliveryMethod) return 0;

      if (draft.deliveryMethod === "gosend") {
        // Prefer dynamic fee if available
        const fee = Number(draft.gosendFee ?? draft.shipGosendFee ?? draft.ship_gosend_fee ?? draft.ship_gosendFee);
        if (Number.isFinite(fee) && fee > 0) return fee;

        // Fallback
        return 15000;
      }
      return 0;
    }

    function calcTotals(itemsObj, draft) {
      let subtotal = 0;
      let itemCount = 0;

      for (const [id, qty] of Object.entries(itemsObj || {})) {
        if (products[id] && qty > 0) {
          subtotal += products[id].price * qty;
          itemCount += qty;
        }
      }

      const packagingFee = itemCount * 1500;
      const deliveryCost = deliveryCostFromDraft(draft);

      return {
        subtotal,
        itemCount,
        packagingFee,
        deliveryCost,
        total: subtotal + packagingFee + deliveryCost,
      };
    }

    function renderTotals() {
      const t = calcTotals(cart, shippingDraft);

      const totalEl = document.getElementById("payment-total");
      if (totalEl) totalEl.textContent = formatRupiah(t.total);

      const placeOrderText = document.getElementById("place-order-text");
      if (placeOrderText) placeOrderText.textContent = `Place Order ${formatRupiah(t.total)}`;

      // Summary box (new)
      document.getElementById("sum-subtotal").textContent = formatRupiah(t.subtotal);
      document.getElementById("sum-packaging").textContent = formatRupiah(t.packagingFee);
      document.getElementById("sum-delivery").textContent = formatRupiah(t.deliveryCost);
      document.getElementById("sum-total").textContent = formatRupiah(t.total);

      // Map info (new)
      const addr = shippingDraft?.shipAddress || shippingDraft?.addressFromMap || "";
      const dist = shippingDraft?.shipDistanceKm ?? null;

      const mapBox = document.getElementById("sum-map");
      if (addr || dist != null) {
        mapBox.classList.remove("hidden");
        document.getElementById("sum-address").textContent = addr || "-";
        document.getElementById("sum-distance").textContent =
          dist != null ? `Distance: ${Number(dist).toFixed(1)} km` : "-";
      } else {
        mapBox.classList.add("hidden");
      }
    }

    function validatePaymentMethod() {
      const selected = document.querySelector('input[name="payment_method"]:checked');
      const btn = document.getElementById("place-order-btn");
      const card = document.getElementById("payment-method-card");

      if (!btn) return;

      // Also require receipt upload
      const receiptOk = !!receiptFileName;

      if (selected && receiptOk) {
        btn.disabled = false;
        btn.classList.remove("opacity-40", "cursor-not-allowed");
        if (card) card.classList.add("border-dark-chocolate");
      } else {
        btn.disabled = true;
        btn.classList.add("opacity-40", "cursor-not-allowed");
        if (card) card.classList.remove("border-dark-chocolate");
      }
    }

    function handleReceiptUpload(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      receiptFileName = file.name;
      receiptFileBlob = file;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.getElementById("receipt-image");
        const icon = document.getElementById("receipt-icon");
        const text = document.getElementById("receipt-text");

        if (img) {
          img.src = e.target.result;
          img.classList.remove("hidden");
        }
        if (icon) icon.classList.add("hidden");
        if (text) text.textContent = "Receipt attached";

        validatePaymentMethod();
      };
      reader.readAsDataURL(file);
    }

    function getSelectedPayment() {
      const radio = document.querySelector('input[name="payment_method"]:checked');
      return radio ? radio.value : null;
    }

    async function placeOrder(ev) {
      const btn = ev?.currentTarget;
      if (!btn) return;

      btn.disabled = true;
      const oldHTML = btn.innerHTML;
      btn.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">refresh</span> Processing';

      try {
        await initSession();
        cart = await getCart();

        // Shipping draft: DB first, then local fallback
        if (!shippingDraft) {
          try {
            shippingDraft = await loadShippingDraftFromDB();
          } catch {}
          if (!shippingDraft) shippingDraft = loadShippingDraftFallbackLocal();
        }

        const t = calcTotals(cart, shippingDraft);

        if (!t.itemCount) {
          alert("Your cart is empty.");
          btn.disabled = false;
          btn.innerHTML = oldHTML;
          return;
        }

        const selectedPayment = getSelectedPayment();
        if (!selectedPayment) {
          alert("Please select payment method.");
          btn.disabled = false;
          btn.innerHTML = oldHTML;
          return;
        }

        if (!receiptFileName) {
          alert("Please upload your receipt.");
          btn.disabled = false;
          btn.innerHTML = oldHTML;
          return;
        }

        // Note:
        // Your current createOrder() only stores fileName metadata.
        // If you want to REALLY upload the image, you need Firebase Storage upload in firebase.js.
        const orderPayload = {
          items: cart,
          pricing: t,
          shipping: shippingDraft || null,
          paymentMethod: selectedPayment,
          receipt: receiptFileName ? { fileName: receiptFileName } : null,
          createdFrom: "payment.html",
        };

        await createOrder(orderPayload);
        navigateTo("success");

      } catch (err) {
        console.error(err);
        alert("Failed to place order.");
        btn.disabled = false;
        btn.innerHTML = oldHTML;
      }
    }

    // Optional: basic auth modal UI handlers (kept so your onclick doesn't error)
    function showLoginForm() {
      document.getElementById("auth-choice")?.classList.add("hidden");
      document.getElementById("guest-view")?.classList.add("hidden");
      document.getElementById("login-form-view")?.classList.remove("hidden");
    }
    function showAuthChoice() {
      document.getElementById("login-form-view")?.classList.add("hidden");
      document.getElementById("guest-view")?.classList.add("hidden");
      document.getElementById("auth-choice")?.classList.remove("hidden");
    }
    function continueAsGuest() {
      document.getElementById("auth-choice")?.classList.add("hidden");
      document.getElementById("login-form-view")?.classList.add("hidden");
      document.getElementById("guest-view")?.classList.remove("hidden");
    }
    function proceedAsGuest() {
      document.getElementById("auth-modal")?.classList.add("hidden");
    }
    function handleLogin() {
      alert("Next step: connect this to Firebase Auth (Email/Google).");
    }

    // Expose globals for inline onclick
    window.navigateTo = navigateTo;
    window.handleReceiptUpload = handleReceiptUpload;
    window.placeOrder = placeOrder;

    window.showLoginForm = showLoginForm;
    window.showAuthChoice = showAuthChoice;
    window.continueAsGuest = continueAsGuest;
    window.proceedAsGuest = proceedAsGuest;
    window.handleLogin = handleLogin;

    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
      radio.addEventListener("change", validatePaymentMethod);
    });

    document.addEventListener("DOMContentLoaded", async () => {
      await initSession();

      cart = await getCart();

      // Shipping draft: DB first, local fallback (important if DB load fails)
      try {
        shippingDraft = await loadShippingDraftFromDB();
      } catch (e) {
        console.warn("Shipping draft DB load failed, fallback to localStorage", e);
      }
      if (!shippingDraft) shippingDraft = loadShippingDraftFallbackLocal();

      renderTotals();
      validatePaymentMethod();

      document.getElementById("place-order-btn")?.addEventListener("click", placeOrder);
    });
  </script>
</body>
</html>
