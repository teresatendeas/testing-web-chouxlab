<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
  <title>ChouxLab - Your Box</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Fraunces:opsz,wght@9..144,300;400;600&family=Inter:wght@300;400;500&family=Work+Sans:wght@300;400;500;700&family=DM+Serif+Display&family=Playfair+Display:wght@400;600;700&family=Alice&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "mocha": "#3D2B1F",
            "dark-chocolate": "#2A1D15",
            "dark-brown": "#32211D",
            "cream": "#FDFBF7",
            "cream-bg": "#FCF9F2",
            "warm-beige": "#F5F0E8",
            "soft-cocoa": "#8B7E74",
            "accent-tan": "#C7B7A3",
            "tan-light": "#f2e4cf",
            "nude": "#E7C0A5",
            "beige": "#EBC2A4",
            "tan": "#D1B28C",
            "warm-grey": "#8E7366",
            "primary": "#36211c",
            "background-light": "#fffcf5",
            "background-dark": "#1a1210",
          },
          fontFamily: {
            "roca": ["Crimson Pro", "serif"],
            "cooper": ["Fraunces", "serif"],
            "display": ["Fraunces", "serif"],
            "accent": ["Alice", "serif"],
            "body": ["Work Sans", "sans-serif"],
            "sans": ["Inter", "sans-serif"],
          },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply bg-cream text-dark-chocolate antialiased;
        font-family: 'Fraunces', serif;
        min-height: 100dvh;
        overflow-x: hidden;
      }
    }

    .font-roca { font-family: 'Crimson Pro', serif; }
    .font-cooper { font-family: 'Fraunces', serif; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
    }

    .fill-1 { font-variation-settings: 'FILL' 1; }

    .bottom-nav-directory {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background-color: rgba(253, 251, 247, 0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(199, 183, 163, 0.2);
      padding: 12px 24px 28px 24px;
      max-width: 430px;
      margin: 0 auto;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .nav-item:active {
      opacity: 0.6;
      transform: scale(0.95);
    }

    .nav-icon { font-size: 24px; line-height: 1; }

    .nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Fraunces', serif;
    }

    .nav-item.active .nav-icon {
      font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    input:focus, textarea:focus {
      outline: none !important;
      box-shadow: none !important;
    }
  </style>

  <!-- ✅ IMPORTANT: define navigation BEFORE module loads -->
  <script>
    window.navigateTo = function (screenName) {
      try {
        if (screenName === "menu") window.location.href = "index.html";
        else window.location.href = screenName + ".html";
      } catch (e) {
        console.error("navigateTo failed:", e);
      }
    };
  </script>
</head>

<body class="bg-cream-bg">
  <div class="relative mx-auto min-h-screen max-w-[430px] bg-cream flex flex-col">

    <header class="sticky top-0 z-50 bg-cream/90 backdrop-blur-md border-b border-accent-tan/10">
      <div class="flex items-center px-6 py-6 justify-between">
        <button class="flex items-center justify-center text-dark-chocolate" onclick="navigateTo('menu')">
          <span class="material-symbols-outlined text-2xl">arrow_back_ios</span>
        </button>
        <h1 class="text-2xl font-roca font-bold tracking-tight text-dark-chocolate">Cart</h1>
        <div class="w-8"></div>
      </div>

      <div class="flex items-center justify-center gap-12 pb-4">
        <div class="flex flex-col items-center gap-2">
          <div class="h-2 w-2 rounded-full bg-dark-chocolate"></div>
          <span class="text-[10px] uppercase tracking-widest font-bold text-dark-chocolate">Cart</span>
        </div>
        <div class="flex flex-col items-center gap-2 opacity-40">
          <div class="h-2 w-2 rounded-full bg-soft-cocoa"></div>
          <span class="text-[10px] uppercase tracking-widest font-semibold text-soft-cocoa">Ship</span>
        </div>
        <div class="flex flex-col items-center gap-2 opacity-40">
          <div class="h-2 w-2 rounded-full bg-soft-cocoa"></div>
          <span class="text-[10px] uppercase tracking-widest font-semibold text-soft-cocoa">Pay</span>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar px-6 pt-6 pb-48" id="cart-items-container">
      <div class="py-16 text-center text-soft-cocoa text-sm font-cooper">Loading…</div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 mx-auto max-w-[430px] z-50">
      <div class="px-6 pt-4 pb-0 bg-cream/95 backdrop-blur-xl border-t border-accent-tan/10 mx-4 mb-[88px] rounded-t-2xl">
        <button id="btn-shipping" onclick="navigateTo('shipping')" class="w-full bg-dark-chocolate text-cream py-5 rounded-full font-bold text-sm tracking-widest uppercase flex items-center justify-center gap-3 transition-transform active:scale-[0.98]">
          Continue to Shipping
          <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </button>
        <div class="flex items-center justify-center gap-2 mt-4 opacity-40 pb-4">
          <span class="material-symbols-outlined text-[14px]">lock</span>
          <p class="text-[9px] uppercase tracking-[0.2em]">Secure Artisan Checkout</p>
        </div>
      </div>

      <nav class="bottom-nav-directory">
        <div class="flex justify-between items-center max-w-md mx-auto">
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('home')">
            <span class="material-symbols-outlined nav-icon">home</span>
            <span class="nav-label">Home</span>
          </button>
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('menu')">
            <span class="material-symbols-outlined nav-icon">restaurant_menu</span>
            <span class="nav-label">Menu</span>
          </button>
          <button class="nav-item active text-mocha" onclick="navigateTo('cart')">
            <span class="material-symbols-outlined nav-icon fill-1">shopping_bag</span>
            <span class="nav-label">Cart</span>
          </button>
          <button class="nav-item text-soft-cocoa" onclick="navigateTo('profile')">
            <span class="material-symbols-outlined nav-icon">person</span>
            <span class="nav-label">Profile</span>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <script type="module">
    import { initSession, getCart, setCart } from "./firebase.js";

    const products = {
      vanilla: { id: "vanilla", name: "Vanilla", price: 65000, image: "https://lh3.googleusercontent.com/aida-public/AB6AXuC-3sZuNZ0QdzsW-tpH_fCQRhECch6sIy5r6A53Mz9d5GcZqbejtxvAM7tpdje6ZqiCrZjT-KFU7wriliD2eX1aNbpFm2Kw1knlFPgGycB_9veYcqxRhvVRgfZoHPl0ZKLOImi_QdcHIlic2qUm7oOMiiX4y2lktKim97R8XGJcXELOp-6opkamS92O1m83Kr54GXO_iUZu7Gfq5rOA4hC9V6Ho-sZWMJR8RpteK9afC1-CqvW-Y_Za2oCyPnqHOvz58puJiaf44cY" },
      chocolate: { id: "chocolate", name: "Chocolate", price: 65000, image: "https://lh3.googleusercontent.com/aida-public/AB6AXuBd6B4bIq35nUTh2pw4BnTnZh8Ny5jE5c1mFoqnv6QU834a3IvZ-ZJCWZ62LxoTMMpKYrOLhl3J5vAd7HMicEciUNSnN9er36uRLZKzCi-qBE8XOOd9SJ9ZlvtN3aJ9rXtQFmTxSG8SoL0RFTY2zQTq7Cj4v3cNSh6_xWkbCn_IbEP1oe1mZbMpkAuyD8VrOZNRIzKMy_pksI2ZsnYYxRkMjdqyPwpSdLQjQVbJSc4o-wV_qkhhzgAIXmRxPdGMB0-39D5W-XwkgyI" },
      pistachio: { id: "pistachio", name: "Pistachio & Rose", price: 85000, image: "https://lh3.googleusercontent.com/aida-public/AB6AXuAYPIicpfGyw9rPQiV4aiwqTzQzp-WALZgrVBf_oMB9RIqkQ24Ye9V9VNwwt0YgKhqd7aqTz52OLyF84j6Y7YSlAkazmZ9yjvMe2nyQ9OgjpJBbn5WcK-vRtqdVjnKs4Ekn-yJkBaLbrF9BNK2rJgPKPKcJa3HPRwOkOS3swsJpCb530s-iI_tP97sgfUWLrd3E4PAg8uzSMBqlw26WktnVPDZ4p9R6maQlMth1rlIr4LKgucIdDhqUKIdeejQvUzWLR_525Y2b_8E" },
    };

    let cartCounts = {};
    let isSaving = false;
    let initRunning = false;

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function setShippingButtonEnabled(enabled) {
      const btn = document.getElementById("btn-shipping");
      if (!btn) return;
      btn.disabled = !enabled;
      if (enabled) btn.classList.remove("opacity-40", "pointer-events-none");
      else btn.classList.add("opacity-40", "pointer-events-none");
    }

    function renderError(container, msg) {
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <span class="material-symbols-outlined text-6xl text-soft-cocoa/30 mb-4">wifi_off</span>
          <h3 class="font-roca text-xl text-dark-chocolate font-bold mb-2">Cart failed to load</h3>
          <p class="text-soft-cocoa font-cooper text-sm mb-6">${msg}</p>
          <button id="retry-btn" class="bg-dark-chocolate text-cream px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest">
            Retry
          </button>
          <button onclick="navigateTo('menu')" class="mt-3 text-[11px] tracking-[0.2em] text-dark-chocolate font-bold">
            GO TO MENU
          </button>
        </div>
      `;
      const retry = document.getElementById("retry-btn");
      if (retry) retry.onclick = () => initCartPage(true);
    }

    function renderEmpty(container) {
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <span class="material-symbols-outlined text-6xl text-soft-cocoa/30 mb-4">shopping_bag</span>
          <h3 class="font-roca text-xl text-dark-chocolate font-bold mb-2">Your cart is empty</h3>
          <p class="text-soft-cocoa font-cooper text-sm mb-6">Add some delicious choux to get started</p>
          <button onclick="navigateTo('menu')" class="bg-dark-chocolate text-cream px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest">
            Browse Menu
          </button>
        </div>
      `;
    }

    async function saveCart() {
      if (isSaving) return;
      isSaving = true;
      try {
        await setCart(cartCounts);
      } catch (e) {
        console.error("setCart failed:", e);
      } finally {
        isSaving = false;
      }
    }

    function renderCart() {
      const container = document.getElementById("cart-items-container");
      if (!container) return;

      container.innerHTML = "";

      const items = [];
      for (const [id, qty] of Object.entries(cartCounts || {})) {
        const q = safeNumber(qty);
        if (q > 0 && products[id]) items.push({ ...products[id], qty: q });
      }

      if (items.length === 0) {
        setShippingButtonEnabled(false);
        renderEmpty(container);
        return;
      }

      setShippingButtonEnabled(true);

      let subtotal = 0;
      let totalQty = 0;

      for (const item of items) {
        subtotal += item.price * item.qty;
        totalQty += item.qty;

        container.innerHTML += `
          <div class="flex items-center gap-4 mb-8">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-2xl size-24 shadow-sm"
              style='background-image: url("${item.image}");'></div>

            <div class="flex-1 flex flex-col gap-2">
              <div>
                <p class="font-roca text-lg font-bold leading-tight text-dark-chocolate">${item.name}</p>
                <p class="font-cooper text-xs text-soft-cocoa mt-0.5">Rp ${item.price.toLocaleString("id-ID")}</p>
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4 bg-warm-beige px-3 py-1.5 rounded-full">
                  <button class="text-mocha/60 hover:text-mocha flex items-center p-1" onclick="updateCartQty('${item.id}', -1)">
                    <span class="material-symbols-outlined text-sm">remove</span>
                  </button>
                  <span class="font-cooper text-sm font-bold w-4 text-center">${item.qty}</span>
                  <button class="text-mocha/60 hover:text-mocha flex items-center p-1" onclick="updateCartQty('${item.id}', 1)">
                    <span class="material-symbols-outlined text-sm font-bold">add</span>
                  </button>
                </div>

                <p class="font-cooper text-sm font-bold text-dark-chocolate">
                  Rp ${(item.price * item.qty).toLocaleString("id-ID")}
                </p>
              </div>
            </div>
          </div>
        `;
      }

      const packaging = totalQty * 900;
      const total = subtotal + packaging;

      container.innerHTML += `
        <div class="py-1 flex justify-start">
          <button class="font-cooper text-[11px] tracking-[0.2em] text-dark-chocolate hover:opacity-70 transition-opacity font-bold" onclick="navigateTo('menu')">
            + ADD MORE ITEMS
          </button>
        </div>

        <div class="mt-12 mb-32 pt-8 border-t border-accent-tan/20">
          <div class="space-y-4">
            <div class="flex justify-between items-baseline">
              <span class="text-dark-chocolate text-sm font-semibold">Box Subtotal</span>
              <span class="font-cooper text-sm font-bold text-dark-chocolate">Rp ${subtotal.toLocaleString("id-ID")}</span>
            </div>

            <div class="flex justify-between items-baseline">
              <span class="text-dark-chocolate text-sm font-semibold">Packaging (${totalQty} items × Rp 900)</span>
              <span class="font-cooper text-sm font-bold text-dark-chocolate">Rp ${packaging.toLocaleString("id-ID")}</span>
            </div>

            <div class="flex justify-between items-center pt-4 border-t border-accent-tan/10">
              <span class="font-roca text-xl font-bold text-dark-chocolate">Total</span>
              <span class="font-cooper text-2xl font-bold text-dark-chocolate">Rp ${total.toLocaleString("id-ID")}</span>
            </div>
          </div>
        </div>
      `;
    }

    async function updateCartQty(productId, delta) {
      const current = safeNumber(cartCounts[productId]);
      const next = current + Number(delta);

      if (next <= 0) delete cartCounts[productId];
      else cartCounts[productId] = next;

      await saveCart();
      renderCart();
    }

    function timeout(ms, label) {
      return new Promise((_, reject) =>
        setTimeout(() => reject(new Error(label || `Timeout after ${ms}ms`)), ms)
      );
    }

    async function initCartPage(force = false) {
      if (initRunning) return;
      initRunning = true;

      const container = document.getElementById("cart-items-container");
      if (container) container.innerHTML = `<div class="py-16 text-center text-soft-cocoa text-sm font-cooper">Loading…</div>`;
      setShippingButtonEnabled(false);

      try {
        // ✅ prevents infinite "Loading…" if auth hangs
        await Promise.race([initSession(), timeout(8000, "Auth timed out")]);

        if (!isSaving || force) {
          cartCounts = await Promise.race([getCart(), timeout(8000, "Cart fetch timed out")]);
        }

        renderCart();
      } catch (e) {
        console.error("Cart init failed:", e);
        cartCounts = {};
        if (container) renderError(container, e?.message || "Please refresh and try again.");
      } finally {
        initRunning = false;
      }
    }

    // init
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => initCartPage(false));
    } else {
      initCartPage(false);
    }

    // back/forward cache
    window.addEventListener("pageshow", () => {
      if (!isSaving) initCartPage(false);
    });

    // expose for inline onclick in generated HTML
    window.updateCartQty = updateCartQty;
  </script>
</body>
</html>
