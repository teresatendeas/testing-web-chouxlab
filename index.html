<script type="module">
  import { initSession, getCart, setCart } from "./firebase.js";

  const products = {
    vanilla: { id: "vanilla", name: "Vanilla", price: 65000 },
    chocolate: { id: "chocolate", name: "Chocolate", price: 65000 },
    pistachio: { id: "pistachio", name: "Pistachio & Rose", price: 85000 },
  };

  let cart = {};
  let currentFilter = "all";

  // Debounce Firestore writes (prevents spam + race)
  let saveTimer = null;
  function queueSaveCart() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      try {
        await setCart(cart);
      } catch (e) {
        console.error("setCart failed:", e);
        alert("Cart save failed. Check console for Firebase error.");
      }
    }, 150);
  }

  function navigateTo(screenName) {
    if (screenName === "menu") window.location.href = "index.html";
    else window.location.href = screenName + ".html";
  }

  function setFilter(filter) {
    currentFilter = filter;

    document.querySelectorAll(".filter-btn").forEach((btn) => {
      if (btn.dataset.filter === filter) {
        btn.classList.add("filter-active");
        btn.classList.remove("bg-white/40", "text-dark-brown", "border-dark-brown/10");
      } else {
        btn.classList.remove("filter-active");
        btn.classList.add("bg-white/40", "text-dark-brown", "border-dark-brown/10");
      }
    });

    const classicsGrid = document.getElementById("classics-grid");
    const seasonalSection = document.getElementById("seasonal-section");
    const signatureHeader = document.getElementById("signature-header");

    if (filter === "all") {
      classicsGrid.style.display = "grid";
      seasonalSection.style.display = "block";
      signatureHeader.style.display = "block";
    } else if (filter === "classics") {
      classicsGrid.style.display = "grid";
      seasonalSection.style.display = "none";
      signatureHeader.style.display = "block";
    } else if (filter === "seasonal") {
      classicsGrid.style.display = "none";
      seasonalSection.style.display = "block";
      signatureHeader.style.display = "none";
    } else if (filter === "gift") {
      classicsGrid.style.display = "none";
      seasonalSection.style.display = "none";
      signatureHeader.style.display = "none";
    }
  }

  function calculateTotal() {
    let total = 0;
    let itemCount = 0;

    for (const [itemId, qty] of Object.entries(cart)) {
      const q = Number(qty);
      if (products[itemId] && Number.isFinite(q) && q > 0) {
        total += products[itemId].price * q;
        itemCount += q;
      }
    }
    return { total, itemCount };
  }

  function updateCartBadge(count) {
    const badge = document.getElementById("cart-badge");
    if (!badge) return;

    if (count > 0) {
      badge.textContent = count;
      badge.classList.remove("hidden");
    } else {
      badge.classList.add("hidden");
    }
  }

  function updateDisplay() {
    const { total, itemCount } = calculateTotal();

    const totalEl = document.getElementById("menu-total");
    if (totalEl) totalEl.textContent = `Rp ${total.toLocaleString("id-ID")}`;

    updateCartBadge(itemCount);

    const footer = document.getElementById("menu-footer");
    if (itemCount > 0) footer.classList.remove("hidden");
    else footer.classList.add("hidden");
  }

  function syncCartUI() {
    ["vanilla", "chocolate", "pistachio"].forEach((itemId) => {
      const addBtn = document.getElementById(`${itemId}-add-btn`);
      const stepper = document.getElementById(`${itemId}-stepper`);
      const qtyEl = document.getElementById(`qty-${itemId}`);
      if (!addBtn || !stepper || !qtyEl) return;

      addBtn.classList.remove("hidden");
      stepper.classList.add("hidden");
      qtyEl.textContent = "1";
    });

    for (const [itemId, qty] of Object.entries(cart)) {
      const q = Number(qty);
      if (!products[itemId] || !Number.isFinite(q) || q <= 0) continue;

      const addBtn = document.getElementById(`${itemId}-add-btn`);
      const stepper = document.getElementById(`${itemId}-stepper`);
      const qtyEl = document.getElementById(`qty-${itemId}`);
      if (!addBtn || !stepper || !qtyEl) continue;

      addBtn.classList.add("hidden");
      stepper.classList.remove("hidden");
      qtyEl.textContent = String(q);
    }

    updateDisplay();
  }

  function toggleItemQty(item, show) {
    const addBtn = document.getElementById(`${item}-add-btn`);
    const stepper = document.getElementById(`${item}-stepper`);
    const qtyEl = document.getElementById(`qty-${item}`);
    if (!addBtn || !stepper || !qtyEl) return;

    if (show) {
      addBtn.classList.add("hidden");
      stepper.classList.remove("hidden");

      const existing = Number(cart[item] || 0);
      cart[item] = existing >= 1 ? existing : 1;
      qtyEl.textContent = String(cart[item]);

      queueSaveCart();
      updateDisplay();
    } else {
      addBtn.classList.remove("hidden");
      stepper.classList.add("hidden");

      delete cart[item];
      qtyEl.textContent = "1";

      queueSaveCart();
      updateDisplay();
    }
  }

  function updateItemQty(item, change) {
    const qtyEl = document.getElementById(`qty-${item}`);
    if (!qtyEl) return;

    const currentQty = Number(cart[item] || 0);
    const next = currentQty + change;

    if (next <= 0) {
      toggleItemQty(item, false);
      return;
    }

    cart[item] = next;
    qtyEl.textContent = String(next);

    queueSaveCart();
    updateDisplay();
  }

  async function initMenuUI() {
    try {
      await initSession();
      cart = await getCart();
      syncCartUI();
    } catch (e) {
      console.error("initMenuUI failed:", e);
      alert("Firebase init failed. Check console (F12).");
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMenuUI);
  } else {
    initMenuUI();
  }

  // expose for inline onclick=""
  window.navigateTo = navigateTo;
  window.setFilter = setFilter;
  window.toggleItemQty = toggleItemQty;
  window.updateItemQty = updateItemQty;
</script>
